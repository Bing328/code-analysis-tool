#!/usr/bin/env bash
set -euo pipefail

# ===== é…ç½®å‚æ•° =====
# ç›‘æŽ§ç»„ä»¶é…ç½®ï¼ˆå¯†ç å¿…é¡»é€šè¿‡çŽ¯å¢ƒå˜é‡è®¾ç½®ï¼‰
if [[ -z "${GRAFANA_ADMIN_PASSWORD:-}" ]]; then
    echo "âŒ é”™è¯¯ï¼šå¿…é¡»è®¾ç½® GRAFANA_ADMIN_PASSWORD çŽ¯å¢ƒå˜é‡"
    echo ""
    echo "è¯·ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€è¿è¡Œï¼š"
    echo ""
    echo "æ–¹æ³•1ï¼šè®¾ç½®çŽ¯å¢ƒå˜é‡"
    echo "    export GRAFANA_ADMIN_PASSWORD=\"your_secure_password\""
    echo "    sudo ./setup_monitor_v2.sh"
    echo ""
    echo "æ–¹æ³•2ï¼šç›´æŽ¥ä¼ é€’çŽ¯å¢ƒå˜é‡"
    echo "    sudo GRAFANA_ADMIN_PASSWORD=\"your_secure_password\" ./setup_monitor_v2.sh"
    echo ""
    exit 1
fi

NODE_EXPORTER_VERSION="${NODE_EXPORTER_VERSION:-1.8.2}"

# è¿œç¨‹éƒ¨ç½²é…ç½®
IPS_FILE="${IPS_FILE:-ips.txt}"
SSH_USER="${SSH_USER:-root}"        # é»˜è®¤SSHç”¨æˆ·ï¼Œå¯ä¿®æ”¹ä¸ºæ™®é€šç”¨æˆ· (å¦‚ ubuntu)
SSH_PORT="${SSH_PORT:-22}"          # SSHç«¯å£

# ===== 0) è¿è¡ŒçŽ¯å¢ƒæ£€æŸ¥ =====
if [[ $EUID -ne 0 ]]; then
   echo "âŒ æœ¬è„šæœ¬éœ€è¦ root æƒé™è¿è¡Œ (ç”¨äºŽé…ç½®æœ¬åœ°Dockerå’Œé˜²ç«å¢™)" 
   echo "è¯·ä½¿ç”¨: sudo $0"
   exit 1
fi

check_dependencies() {
    local deps=("docker" "curl" "ssh" "scp" "jq")
    local missing=()
    
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" >/dev/null 2>&1; then
            missing+=("$dep")
        fi
    done
    
    # æ£€æŸ¥ docker compose (å…¼å®¹ v1 å’Œ v2)
    if ! command -v docker-compose >/dev/null 2>&1 && ! docker compose version >/dev/null 2>&1; then
        missing+=("docker compose")
    fi
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        echo "âŒ ç¼ºå°‘å¿…è¦ä¾èµ–: ${missing[*]}"
        echo "è¯·å…ˆå®‰è£…è¿™äº›å·¥å…·: apt-get install docker.io curl openssh-client jq"
        exit 1
    fi
}
check_dependencies

# ===== 1) å‡†å¤‡ç›®å½•ä¸Žå¤‡ä»½ =====
BASE_DIR="monitor-stack"

if [[ -d "$BASE_DIR" ]]; then
    BACKUP_NAME="${BASE_DIR}.backup.$(date +%Y%m%d_%H%M%S)"
    echo "ðŸ“¦ æ£€æµ‹åˆ°æ—§é…ç½®ï¼Œå¤‡ä»½è‡³: $BACKUP_NAME"
    cp -r "$BASE_DIR" "$BACKUP_NAME"
fi

echo "ðŸ“ åˆ›å»ºç›®å½•ç»“æž„..."
mkdir -p "$BASE_DIR"/{prometheus/{rules,targets},alertmanager,grafana/provisioning/{datasources,dashboards}}

# !!! å…³é”®æ”¹è¿›ï¼šä¿®å¤ Prometheus å®¹å™¨(UID 65534)çš„å†™å…¥æƒé™é—®é¢˜ !!!
# Prometheus å’Œ Alertmanager å®¹å™¨é»˜è®¤ä»¥ nobody ç”¨æˆ·è¿è¡Œ
echo "ðŸ”’ ä¿®æ­£æ•°æ®ç›®å½•æƒé™..."
chown -R 65534:65534 "$BASE_DIR/prometheus"
chown -R 65534:65534 "$BASE_DIR/alertmanager"

cd "$BASE_DIR"

# ===== 2) ç”Ÿæˆ docker-compose.yml =====
cat > docker-compose.yml <<EOF
version: "3.8"
services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    user: "65534:65534"
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus:/etc/prometheus
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-admin-api"
      - "--web.enable-lifecycle"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped
    user: "65534:65534"
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager:/etc/alertmanager
      - alertmanager-data:/alertmanager
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
      - "--storage.path=/alertmanager"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    user: "472:472"
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  prometheus-data:
  alertmanager-data:
  grafana-data:
