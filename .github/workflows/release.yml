name: Release Pipeline

on:
  push:
    tags:
      - 'v*.*.*'  # è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾
    
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬ (æ ¼å¼: v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  PROJECT_NAME: 'CodeAuditor'
  VERSION: ${{ github.ref_name || inputs.version }}

jobs:
  # ç¬¬ä¸€é˜¶æ®µ: æµ‹è¯•
  test:
    name: ðŸ§ª è¿è¡Œæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: ðŸ“¦ å®‰è£…æµ‹è¯•ä¾èµ–
      run: |
        pip install pytest pytest-cov
        if [ -f requirements-test.txt ]; then
          pip install -r requirements-test.txt
        fi
    
    - name: ðŸ§ª è¿è¡Œæµ‹è¯•
      run: |
        # åˆ›å»ºç®€å•çš„æµ‹è¯•è„šæœ¬
        cat > test_auditor.py << 'EOF'
        import sys
        import os
        
        # æ·»åŠ é¡¹ç›®è·¯å¾„
        sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
        
        try:
            # æµ‹è¯•å¯¼å…¥
            import professional__v2
            print("âœ… ä¸»æ¨¡å—å¯¼å…¥æˆåŠŸ")
            
            # æµ‹è¯•Configç±»
            from professional__v2 import Config
            config = Config()
            print(f"âœ… Configç±»åˆå§‹åŒ–æˆåŠŸ")
            print(f"   æ”¯æŒ {len(config.FILE_TYPES)} ç§æ–‡ä»¶ç±»åž‹")
            
            # æµ‹è¯•é¢œè‰²ç±»
            from professional__v2 import Colors
            print(f"âœ… Colorsç±»å¯ç”¨")
            
            print("\nâœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼")
            sys.exit(0)
        except Exception as e:
            print(f"âŒ æµ‹è¯•å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            sys.exit(1)
        EOF
        
        python test_auditor.py
    
    - name: ðŸ“Š ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        echo "è¿è¡Œä»£ç æ£€æŸ¥..."
        pip install flake8 pylint
        
        # åŸºæœ¬è¯­æ³•æ£€æŸ¥
        python -m py_compile professional__v2.py && echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡"
        
        # ç®€å•çš„ä»£ç è§„èŒƒæ£€æŸ¥
        if flake8 --max-line-length=120 professional__v2.py; then
          echo "âœ… ä»£ç è§„èŒƒæ£€æŸ¥é€šè¿‡"
        else
          echo "âš ï¸  ä»£ç è§„èŒƒæœ‰å¾…æ”¹è¿›"
        fi

  # ç¬¬äºŒé˜¶æ®µ: æž„å»ºæ‰€æœ‰å¹³å°
  build:
    name: ðŸ”¨ æž„å»ºæ‰€æœ‰å¹³å°
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        target: [windows-64, linux-64, windows-32]
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: ðŸ“¦ å®‰è£…æž„å»ºå·¥å…·
      run: |
        sudo apt-get update
        case "${{ matrix.target }}" in
          windows-*)
            sudo apt-get install -y mingw-w64
            if [ "${{ matrix.target }}" = "windows-32" ]; then
              export TARGET_ARCH="32"
              export CC="i686-w64-mingw32-gcc"
            else
              export TARGET_ARCH="64"
              export CC="x86_64-w64-mingw32-gcc"
            fi
            ;;
          linux-*)
            # LinuxåŽŸç”Ÿæž„å»ºï¼Œä¸éœ€è¦ç‰¹æ®Šå·¥å…·
            ;;
        esac
        
        pip install pyinstaller
    
    - name: ðŸ”¨ æž„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        OUTPUT_NAME="${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.target }}"
        
        case "${{ matrix.target }}" in
          windows-*)
            EXT=".exe"
            if [ "${{ matrix.target }}" = "windows-32" ]; then
              echo "æž„å»º32ä½Windowsç‰ˆæœ¬..."
              # 32ä½æž„å»º
              pyinstaller --onefile --console \
                --name "${{ env.PROJECT_NAME }}" \
                --distpath "./dist/$OUTPUT_NAME" \
                professional__v2.py
            else
              echo "æž„å»º64ä½Windowsç‰ˆæœ¬..."
              # 64ä½æž„å»º
              pyinstaller --onefile --console \
                --name "${{ env.PROJECT_NAME }}" \
                --distpath "./dist/$OUTPUT_NAME" \
                professional__v2.py
            fi
            ;;
          linux-*)
            EXT=""
            echo "æž„å»ºLinuxç‰ˆæœ¬..."
            pyinstaller --onefile --console \
              --name "${{ env.PROJECT_NAME }}" \
              --distpath "./dist/$OUTPUT_NAME" \
              professional__v2.py
            ;;
        esac
        
        # é‡å‘½åæ–‡ä»¶
        if [ "${{ matrix.target }}" = "linux-64" ]; then
          mv "./dist/$OUTPUT_NAME/${{ env.PROJECT_NAME }}" \
             "./dist/$OUTPUT_NAME/$OUTPUT_NAME"
        else
          mv "./dist/$OUTPUT_NAME/${{ env.PROJECT_NAME }}$EXT" \
             "./dist/$OUTPUT_NAME/$OUTPUT_NAME$EXT"
        fi
    
    - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.target }}
        path: ./dist/${{ env.PROJECT_NAME }}-${{ env.VERSION }}-${{ matrix.target }}/
        retention-days: 7

  # ç¬¬ä¸‰é˜¶æ®µ: åˆ›å»ºå‘å¸ƒ
  release:
    name: ðŸš€ åˆ›å»ºGitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    
    steps:
    - name: ðŸ“¥ ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
    
    - name: ðŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        echo "å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
        mkdir -p ./release
        
        # æ”¶é›†æ‰€æœ‰æ–‡ä»¶
        find ./artifacts -type f \( -name "*.exe" -o -name "CodeAuditor*" \) -exec cp {} ./release/ \;
        
        # åˆ›å»ºç­¾åæ–‡ä»¶
        for file in ./release/*; do
          sha256sum "$file" > "$file.sha256"
        done
        
        # åˆ›å»ºè¯¦ç»†çš„å‘å¸ƒè¯´æ˜Ž
        cat > ./release/README.md << EOF
        # ä»£ç å®¡è®¡å·¥å…· ${{ env.VERSION }}
        
        ## ä¸‹è½½è¯´æ˜Ž
        
        æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ï¼š
        
        ### Windows ç”¨æˆ·
        - **64ä½ç³»ç»Ÿ**: ä¸‹è½½ \`CodeAuditor-${{ env.VERSION }}-windows-64.exe\`
        - **32ä½ç³»ç»Ÿ**: ä¸‹è½½ \`CodeAuditor-${{ env.VERSION }}-windows-32.exe\`
        
        ### Linux ç”¨æˆ·
        - **64ä½ç³»ç»Ÿ**: ä¸‹è½½ \`CodeAuditor-${{ env.VERSION }}-linux-64\`
        
        ## æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
        
        ä¸‹è½½æ–‡ä»¶åŽï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ ¡éªŒSHA256ï¼š
        \`\`\`bash
        # Windows (PowerShell)
        Get-FileHash -Algorithm SHA256 æ–‡ä»¶å.exe
        
        # Linux/Mac
        shasum -a 256 æ–‡ä»¶å
        \`\`\`
        
        æˆ–ä¸Žå¯¹åº”çš„ \`.sha256\` æ–‡ä»¶å†…å®¹è¿›è¡Œæ¯”è¾ƒã€‚
        
        ## ä½¿ç”¨è¯´æ˜Ž
        
        1. **Windows**: åŒå‡»EXEæ–‡ä»¶è¿è¡Œ
        2. **Linux**: æ·»åŠ æ‰§è¡Œæƒé™åŽè¿è¡Œ
           \`\`\`bash
           chmod +x CodeAuditor-${{ env.VERSION }}-linux-64
           ./CodeAuditor-${{ env.VERSION }}-linux-64
           \`\`\`
        
        ## æž„å»ºä¿¡æ¯
        - ç‰ˆæœ¬: ${{ env.VERSION }}
        - æž„å»ºæ—¶é—´: $(date)
        - æäº¤: ${{ github.sha }}
        
        ## æ–‡ä»¶åˆ—è¡¨
        \`\`\`
        $(ls -la ./release/)
        \`\`\`
        EOF
        
        echo "å‘å¸ƒæ–‡ä»¶å‡†å¤‡å®Œæˆ:"
        ls -lh ./release/
    
    - name: ðŸ·ï¸ åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        name: "ä»£ç å®¡è®¡å·¥å…· ${{ env.VERSION }}"
        body_path: ./release/README.md
        files: |
          ./release/*
        draft: false
        prerelease: ${{ contains(env.VERSION, 'beta') || contains(env.VERSION, 'alpha') || contains(env.VERSION, 'rc') }}
        generate_release_notes: true
    
    - name: ðŸ”” å‘é€é€šçŸ¥
      if: success()
      run: |
        echo "å‘å¸ƒå®Œæˆ: ${{ env.VERSION }}"
        echo "ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ env.VERSION }}"