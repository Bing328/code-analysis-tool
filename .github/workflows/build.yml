name: Build Windows Executable

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64
        # éªŒè¯å®‰è£…
        x86_64-w64-mingw32-gcc --version
    
    - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        # å¦‚æœæœ‰requirements.txtï¼Œå¯ä»¥å®‰è£…å…¶ä»–ä¾èµ–
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
    
    - name: ğŸ”¨ æ„å»ºWindows EXE
      run: |
        echo "å¼€å§‹æ„å»ºWindowså¯æ‰§è¡Œæ–‡ä»¶..."
        
        # æ„å»ºå‘½ä»¤
        pyinstaller --onefile --console \
          --name "CodeAuditor" \
          --clean \
          --distpath ./dist/windows \
          --workpath ./build \
          --specpath ./build \
          --hidden-import urllib.request \
          --hidden-import urllib.error \
          --hidden-import urllib.parse \
          --hidden-import html \
          --hidden-import typing \
          professional__v2.py
        
        # éªŒè¯æ„å»ºç»“æœ
        echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥æ–‡ä»¶..."
        file ./dist/windows/CodeAuditor.exe || echo "æ–‡ä»¶æœªç”Ÿæˆ"
        ls -lh ./dist/windows/
    
    - name: ğŸ” éªŒè¯æ„å»ºç»“æœ
      run: |
        echo "éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶..."
        if [ -f ./dist/windows/CodeAuditor.exe ]; then
          echo "âœ… EXEæ–‡ä»¶å·²ç”Ÿæˆ"
          # ä½¿ç”¨fileå‘½ä»¤æ£€æŸ¥æ–‡ä»¶ç±»å‹
          file ./dist/windows/CodeAuditor.exe
          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
          ls -lh ./dist/windows/CodeAuditor.exe
          # æ£€æŸ¥æ˜¯å¦ä¸ºPEæ–‡ä»¶
          if file ./dist/windows/CodeAuditor.exe | grep -q "PE32"; then
            echo "âœ… æ–‡ä»¶æ˜¯æœ‰æ•ˆçš„Windowså¯æ‰§è¡Œæ–‡ä»¶"
          else
            echo "âŒ æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„Windowså¯æ‰§è¡Œæ–‡ä»¶"
            exit 1
          fi
        else
          echo "âŒ EXEæ–‡ä»¶æœªç”Ÿæˆ"
          exit 1
        fi
    
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: CodeAuditor-Windows
        path: |
          ./dist/windows/CodeAuditor.exe
          ./dist/windows/
        if-no-files-found: error
        retention-days: 7