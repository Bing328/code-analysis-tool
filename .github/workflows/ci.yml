name: CI/CD Pipeline - Optimized

on:
  push:
    branches: [main, master]
    tags: ['v*.*.*']
  pull_request:
    branches: [main, master]
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  # ä¿®æ”¹ï¼šè®¾ä¸º trueï¼Œæœ‰æ–°æäº¤æ—¶å–æ¶ˆæ—§çš„è¿è¡Œï¼ŒèŠ‚çœèµ„æº
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.10"
  PROJECT_NAME: "code-analysis-tool"

jobs:
  # å¿«é€Ÿæ£€æŸ¥ - åªåšåŸºæœ¬éªŒè¯
  quick-check:
    name: Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate repository structure
      run: |
        echo "ğŸ“ éªŒè¯é¡¹ç›®ç»“æ„..."
        ls -la
        # ä¿®æ”¹ï¼šå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ exit 1 å¼ºåˆ¶å¤±è´¥
        test -f professional_code_auditor_v2.py && echo "âœ… ä¸»ç¨‹åºæ–‡ä»¶å­˜åœ¨" || (echo "âŒ ä¸»ç¨‹åºæ–‡ä»¶ç¼ºå¤±" && exit 1)
        test -f config.yaml && echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨" || (echo "âŒ é…ç½®æ–‡ä»¶ç¼ºå¤±" && exit 1)
        test -f requirements.txt && echo "âœ… ä¾èµ–æ–‡ä»¶å­˜åœ¨" || (echo "âŒ ä¾èµ–æ–‡ä»¶ç¼ºå¤±" && exit 1)

  # ä»£ç è´¨é‡æ£€æŸ¥
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quick-check
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 isort
    
    - name: Check with Black
      # ä¿®æ”¹ï¼šç§»é™¤äº† || echoï¼Œç¡®ä¿æ ¼å¼é”™è¯¯æ—¶ CI æŠ¥é”™
      run: black --check --diff .
    
    - name: Check with Flake8
      # ä¿®æ”¹ï¼šç§»é™¤äº† || echo
      run: flake8 . --count --max-line-length=127

  # åŸºæœ¬æµ‹è¯•
  test:
    name: Basic Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: lint
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest
    
    - name: Run basic tests
      run: |
        echo "ğŸ§ª è¿è¡ŒåŸºæœ¬æµ‹è¯•..."
        # è¿™é‡Œçš„ exit(1) æ˜¯æ­£ç¡®çš„ï¼Œä¿ç•™
        python -c "
        import sys
        sys.path.insert(0, '.')
        try:
            import professional_code_auditor_v2
            print('âœ… ä¸»ç¨‹åºå¯ä»¥å¯¼å…¥')
        except Exception as e:
            print(f'âŒ å¯¼å…¥å¤±è´¥: {e}')
            sys.exit(1)
        "
        
        # è¿è¡Œç¤ºä¾‹æµ‹è¯•
        if [ -f "tests/test_basic.py" ]; then
          python -m pytest tests/test_basic.py -v
        else
          echo "ğŸ“ æœªæ‰¾åˆ°æµ‹è¯•æ–‡ä»¶ï¼Œè·³è¿‡æµ‹è¯•"
        fi

  # æ„å»ºLinuxå¯æ‰§è¡Œæ–‡ä»¶
  build-linux:
    name: Build Linux Executable
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build executable
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»ºLinuxå¯æ‰§è¡Œæ–‡ä»¶..."
        
        # æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
        echo "ğŸ“¦ ä½¿ç”¨PyInstalleræ‰“åŒ…..."
        # æ³¨æ„ï¼šå¦‚æœ analyzers æ˜¯ Python æ¨¡å—ä»£ç è€Œéçº¯æ•°æ®ï¼Œå»ºè®®æ”¹ç”¨ --hidden-import æˆ– --collect-submodules
        pyinstaller --onefile \
          --name "${{ env.PROJECT_NAME }}" \
          --hidden-import=yaml \
          --hidden-import=colorama \
          --add-data "config.yaml:." \
          --add-data "analyzers:analyzers" \
          professional_code_auditor_v2.py
        
        echo "âœ… æ„å»ºå®Œæˆ"
    
    - name: Test executable
      run: |
        echo "ğŸ§ª æµ‹è¯•ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶..."
        # ä¿®æ”¹ï¼šç§»é™¤äº† || echoï¼Œå¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶æ— æ³•è¿è¡Œï¼ˆå¦‚æ®µé”™è¯¯ï¼‰ï¼Œå¿…é¡»è®© CI å¤±è´¥
        ./dist/${{ env.PROJECT_NAME }} --help
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-executable
        path: dist/
        retention-days: 7

  # æ„å»ºDockeré•œåƒï¼ˆç®€åŒ–ç‰ˆï¼‰
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build-linux
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
        docker build -t ${{ env.PROJECT_NAME }}:test .
        
        echo "ğŸ§ª æµ‹è¯•Dockeré•œåƒ..."
        # ä¿®æ”¹ï¼šç¡®ä¿è¿è¡Œå¤±è´¥æ—¶æŠ¥é”™
        docker run --rm ${{ env.PROJECT_NAME }}:test --help

  # åˆ›å»ºå‘å¸ƒï¼ˆä»…åœ¨æ ‡ç­¾æ—¶è¿è¡Œï¼‰
  release:
    name: Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build-docker
    
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download Linux executable
      uses: actions/download-artifact@v4
      with:
        name: linux-executable
        path: dist/
    
    - name: Create GitHub Release
      # ä¿®æ”¹ï¼šå‡çº§åˆ° v2
      uses: softprops/action-gh-release@v2
      with:
        files: |
          dist/${{ env.PROJECT_NAME }}
          config.yaml
          LICENSE
          README.md
        draft: false
        prerelease: false
        generate_release_notes: true
